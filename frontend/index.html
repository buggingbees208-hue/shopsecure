<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home | ShopSecure</title>

<style>
body {
    background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
    url('https://images.unsplash.com/photo-1472851294608-062f824d29cc?q=80&w=1470') no-repeat center center fixed;
    background-size: cover;
    font-family: 'Poppins', sans-serif;
    margin: 0;
    color: #333;
}

nav {
    background: rgba(44, 62, 80, 0.9);
    padding: 15px 50px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo { color: white; font-size: 24px; font-weight: bold; }

.nav-links a {
    color: #ddd;
    text-decoration: none;
    margin-left: 20px;
    font-weight: 500;
    cursor: pointer;
}
.nav-links a:hover { color: #27ae60; }

.admin-btn {
    border: 1px solid #f1c40f;
    padding: 5px 15px;
    border-radius: 20px;
    color: #f1c40f !important;
}

.container {
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 15px;
    margin: 40px auto;
    max-width: 1100px;
}

.product-grid {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.product-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    width: 240px;
    text-align: center;
}

.p-img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
}

.price {
    color: #27ae60;
    font-weight: bold;
    font-size: 18px;
}

.buy-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    width: 100%;
    cursor: pointer;
}

.modal {
    display:none;
    position: fixed;
    top:50%;
    left:50%;
    transform: translate(-50%,-50%);
    background:white;
    padding:25px;
    border-radius:10px;
    width:340px;
    z-index:1000;
}

.overlay {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    z-index:999;
}
</style>
</head>

<body>

<nav>
<div class="logo">ðŸ›’ ShopSecure</div>
<div class="nav-links">
<a href="index.html">Shop</a>
<a href="returns.html">Returns</a>
<a id="admin_link" href="admin.html" class="admin-btn" style="display:none;">Admin Dashboard</a>
<a onclick="logout()">Logout</a>
</div>
</nav>

<div class="overlay" id="overlay"></div>

<div class="container">
<h2 style="text-align:center;">Recommended Products</h2>

<div class="product-grid">

<div class="product-card">
<img src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=600" class="p-img">
<h3>Premium Watch</h3>
<p class="price">â‚¹299</p>
<button class="buy-btn" onclick="openOrderModal('Premium Watch',299)">Buy Now</button>
</div>

<div class="product-card">
<img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=600" class="p-img">
<h3>Sport Sneakers</h3>
<p class="price">â‚¹249</p>
<button class="buy-btn" onclick="openOrderModal('Sport Sneakers',249)">Buy Now</button>
</div>

</div>
</div>

<!-- Order Modal -->
<div id="orderModal" class="modal">
<h3>Checkout</h3>
<p id="selectedProduct" style="color:#27ae60;font-weight:bold;"></p>
<textarea id="address" rows="3" style="width:100%;margin-bottom:10px;" placeholder="Delivery Address"></textarea>

<select id="payment_type" style="width:100%;margin-bottom:15px;">
<option value="COD">Cash on Delivery</option>
<option value="UPI">UPI</option>
</select>

<button onclick="confirmPurchase()" class="buy-btn">Place Order</button>
<button onclick="closeModal()" style="margin-top:5px;width:100%;">Cancel</button>
</div>

<!-- OTP Modal -->
<div id="deliveryModal" class="modal" style="text-align:center;">
<h3>Enter Delivery OTP</h3>
<input type="text" id="delivery_otp" maxlength="4"
style="width:80%;padding:10px;text-align:center;font-size:20px;margin-bottom:15px;">
<button onclick="verifyDelivery()" class="buy-btn">Verify</button>
</div>

<script>

/* âœ… Auto Detect Local or Render */
const API = window.location.hostname === "127.0.0.1" || 
            window.location.hostname === "localhost"
            ? "http://127.0.0.1:8000"
            : "https://your-app-name.onrender.com";

let selectedProductName="";
let selectedProductPrice=0;
let currentOrderId=null;

window.onload=function(){

    const email=localStorage.getItem("user_email");
    const role=localStorage.getItem("role");

    if(!email){
        window.location.href="login.html";
        return;
    }

    if(role==="admin"){
        document.getElementById("admin_link").style.display="inline-block";
    }
};

function openOrderModal(name,price){
    selectedProductName=name;
    selectedProductPrice=price;
    document.getElementById("selectedProduct").innerText=
        name+" - â‚¹"+price;

    document.getElementById("orderModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(){
    document.getElementById("orderModal").style.display="none";
    document.getElementById("deliveryModal").style.display="none";
    document.getElementById("overlay").style.display="none";
}

async function confirmPurchase(){

    const address=document.getElementById("address").value;
    const userId=localStorage.getItem("user_id");

    if(!address) return alert("Enter delivery address");

    const orderData={
        user_id:parseInt(userId),
        product_name:selectedProductName,
        price:selectedProductPrice,
        address:address,
        payment_type:document.getElementById("payment_type").value
    };

    try{
        const res=await fetch(`${API}/order`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(orderData)
        });

        const data=await res.json();

        if(res.ok){
            currentOrderId=data.order_id;
            alert("Order placed! OTP sent to email.");
            closeModal();
            showOTPModal();
        }else{
            alert(data.detail || "Order failed");
        }
    }catch(e){
        alert("Server connection error");
    }
}

function showOTPModal(){
    document.getElementById("deliveryModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

async function verifyDelivery(){

    const otp=document.getElementById("delivery_otp").value;
    const email=localStorage.getItem("user_email");

    try{
        const res=await fetch(`${API}/verify-otp`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                email:email,
                otp:otp,
                order_id:currentOrderId
            })
        });

        if(res.ok){
            alert("Delivery Verified!");
            window.location.href=`feedback.html?email=${email}`;
        }else{
            alert("Invalid OTP");
        }
    }catch(e){
        alert("Verification failed");
    }
}

function logout(){
    localStorage.clear();
    window.location.href="login.html";
}

</script>
</body>
</html>
